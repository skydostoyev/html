<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  　　<meta name="viewport" content="width=device-width" >
  <title>AWS-MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="jquery-3.6.1.min.js"></script>
  <link rel="stylesheet" href="bulma.css">
 <style>
   body{
      width: 100%;
      max-width: 304px;
      margin: auto;
   }
  
</style>
</head>
<body>
   <div >
      <div class="navbar-brand">
        
           <h1 class="is-size-1">Solar Energy</h1 >
        
      </div>
         <div>
            <button id="btnOnOff" class="button" type="button" onclick="publish()">CONNECT</button>
            <img  id="imgOffOn" class="fit-picture" src="" alt="" style="display:block">           
         </div>
      </div>
<script>
   const ticks = ((new Date().getTime() * 10000) + 621355968000000000);
   const searchParams = new URLSearchParams(window.location.search)
   const mqttOpt = { keepalive: 60*10};
   mqttOpt.username = searchParams.get('u');
   mqttOpt.password = searchParams.get('p');
   mqttOpt.clientId = mqttOpt.username+"-"+ticks;
   
</script>
<script>
   const state = {subscribe: false,isOn:true}
   let topic = "users/" + mqttOpt.username + "/value"
   var img = new Array();
   img[0] = new Image();
   img[0].src = "imgOff.png";
   img[1] = new Image();
   img[1].src = "imgOn.png";
   img[2] = new Image();
   img[2].src = "off.png";
</script>
<script>
   let client;
   
      function connect() {
         state.subscribe=false
         state.isOn=true
         client = mqtt.connect('wss://a1zozlrub2di0x-ats.iot.ap-northeast-1.amazonaws.com:443?x-amz-customauthorizer-name=iotCCustomAuth&testonly=yokohama',mqttOpt);
      
      }
      connect()

      client.on('connect', function () {
         client.publish(topic,"false");
         if(!state.subscribe){
            client.subscribe(topic, function (err) {     
                  if (!err) {
                     //alert("購読開始")
                  }
               })
               state.subscribe=true;
            }
      })
      
   client.on('message', function (topic, message) {
     // try{
         const msg=message.toString();
         state.isOn=msg=="true";
         document.getElementById("btnOnOff").innerText=(state.isOn?"OFF":"ON");
         const src=msg==true.toString()?img[1].src:msg==false.toString()?img[0].src:null
         if(src){
         document.getElementById("imgOffOn").src=src
         }
      //}catch{}     
      })
      client.on('offline', function () {
         client.end() 
      })
   
</script>
<script>  
   window.onclose = ()=>{client.end();}
   function publish(){
      
      if(!client.connected){
         connect()
         alert("接続中")
        
         return;
      }
       client.publish(topic,(!state.isOn).toString());
      
   }
</script>
</body>
</html>



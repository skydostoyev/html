<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>AWS-MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body>
<div id="id_pub">
   <button  type="button" onclick="publish()">送信</button>
</div>
<div id="id_sub">
   <p>受信</p>
</div>
</div>
<div><ul id="ul_msg"></ul></div>
<script>
   function appendMsg(msg){
      var ul_msg=document.getElementById("ul_msg");
      var li = document.createElement('li');
      li.innerHTML = msg;
      ul_msg.appendChild(li);
   }
   function getHMS(){
      const date = new Date();
      const hms = date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();
      return '{"送信時刻":' + hms + '}'
   }
</script>
<script>
   const ticks = ((new Date().getTime() * 10000) + 621355968000000000);
   const searchParams = new URLSearchParams(window.location.search)
   const pub_sub = searchParams.get('pub_sub');
   const mqttOpt = { keepalive: 60};
   mqttOpt.username=searchParams.get('user');
   mqttOpt.password=searchParams.get('pwd');
   mqttOpt.clientId=searchParams.get('clientId');
   if(mqttOpt.username==null){
      mqttOpt.username='test';
      mqttOpt.password='test';
      mqttOpt.clientId=mqttOpt.username+"-"+ticks;
   }   
</script>

<script>
   const state = {sbscribe: false}
   let topic = "users/" + mqttOpt.username + "/value"
   
</script>
<script>
   let client = mqtt.connect('wss://a1zozlrub2di0x-ats.iot.ap-northeast-1.amazonaws.com:443?x-amz-customauthorizer-name=iotCCustomAuth&testonly=yokohama',mqttOpt);

   client.on('connect', function () {
   appendMsg("CONNECTED")
   if(!state.sbscribe){
      client.subscribe(topic, function (err) {     
            if (!err) {
               appendMsg("SUBSCRIBE")      
            }
         })
         state.sbscribe=true;
      }
   })

  client.on('message', function (topic, message) {
  // message is Buffer
  appendMsg(message.toString())
 // client.end()
})

</script>
<script>
   window.onload=()=>{
       if(pub_sub!="sub"){
         const elem=document.getElementById("id_sub");
         elem.style.visibility ="hidden";
      }
      else{
         const elem=document.getElementById("id_pub");
         elem.style.visibility ="hidden";
      }
   }
</script>
<script>
  
  
   window.onclose = ()=>{client.end();}
   function publish(){client.publish(topic,getHMS())}
</script>
</body>

</html>



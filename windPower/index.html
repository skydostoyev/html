<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  　　<meta name="viewport" content="width=device-width" >
  <title>AWS-MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="jquery-3.6.1.min.js"></script>
  <link href="picnic.min.css" rel="stylesheet" />
 
</head>
<body>
   <article class="card">
      <header><h3>Wind Power</h3><h4 id="h4_wp"></h4></header>
   </article>
   <article class="card">
      <header>        
         <div>
            <button id="btnOnOff" class="btn primary" type="button" onclick="publish()">CONNECT</button>
            <img  id="imgOffOn" class="fit-picture" src="" alt="" style="display:block">           
         </div>         
      </header>
    </article>
      
<script>
   const ticks = ((new Date().getTime() * 10000) + 621355968000000000);
   const searchParams = new URLSearchParams(window.location.search)
   const mqttOpt = { keepalive: 60*10};
   mqttOpt.username = searchParams.get('u');
   mqttOpt.password = searchParams.get('p');
   mqttOpt.clientId = mqttOpt.username+"-"+ticks;
   
</script>
<script>
   const state = {subscribe: false,isOn:false}
   let topic = "users/" + mqttOpt.username + "/value"
   var img = new Array();
   img[0] = new Image();
   img[0].src = "imgOff.png";
   img[1] = new Image();
   img[1].src = "imgOn.png";
   img[2] = new Image();
   img[2].src = "off.png";
</script>
<script>
   let client;
   
      client = mqtt.connect('wss://a1zozlrub2di0x-ats.iot.ap-northeast-1.amazonaws.com:443?x-amz-customauthorizer-name=iotCCustomAuth&testonly=yokohama',mqttOpt);

      client.on('connect', function () {
         document.getElementById("btnOnOff").innerText="CONNECT";
         document.getElementById("imgOffOn").src=img[2]
         
         if(!state.subscribe){
            client.subscribe(topic, function (err) {     
                  if (!err) {
                  }
               })
               state.subscribe=true;
            }
      })
      
   client.on('message', function (topic, message) {
      try{
         const msg=message.toString();
         state.isOn=msg=="true";
         document.getElementById("btnOnOff").innerText=(state.isOn?"OFF":"ON");
         const src=msg==true.toString()?img[1].src:msg==false.toString()?img[0].src:null
         if(src){
         document.getElementById("imgOffOn").src=src
         }
      }catch{}
   // client.end()
      })
      client.on('offline', function () {
      })
   
</script>
<script>  
   window.onclose = ()=>{client.end();}
   function publish(){
      // const    date = new Date();
      // alert(
      //    mqttOpt.username +
      //    date.getMonth().toString().padStart(2,"0") +
      //    date.getDate().toString().padStart(2,"0"));

      if(!client.connected){return;}
      state.isOn=!state.isOn;
      document.getElementById("btnOnOff").innerText=(state.isOn?"OFF":"ON");
      
      client.publish(topic,state.isOn.toString());
      
   }
</script>
</body>
</html>


